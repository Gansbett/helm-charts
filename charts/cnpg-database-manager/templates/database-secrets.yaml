{{- range $clusterName, $cluster := .Values.clusters }}
{{- if $cluster.enabled }}
{{- if $cluster.databases }}
{{- range $database := $cluster.databases }}
{{- if not $database.existingSecret }}
{{- $secretName := printf "%s-%s-creds" $clusterName (include "cnpg-database-manager.sanitizeName" $database.name) }}
{{- $existingSecret := lookup "v1" "Secret" $.Release.Namespace $secretName }}
{{- $password := "" }}
{{- if $existingSecret }}
{{- $password = index $existingSecret.data "password" }}
{{- else }}
{{- $password = randAlphaNum 32 | b64enc }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "cnpg-databases.labels" $ | nindent 4 }}
    cnpg.io/cluster: {{ $clusterName }}
    cnpg.io/database: {{ $database.name }}
type: Opaque
data:
  username: {{ $database.owner | b64enc | quote }}
  password: {{ $password | quote }}
  dbname: {{ $database.name | b64enc | quote }}
  host: {{ printf "%s-rw" $clusterName | b64enc | quote }}
  port: {{ "5432" | b64enc | quote }}
  # Connection string for convenience
  jdbc-url: {{ printf "jdbc:postgresql://%s-rw:5432/%s" $clusterName $database.name | b64enc | quote }}
  uri: {{ printf "postgresql://%s:$(password)@%s-rw:5432/%s" $database.owner $clusterName $database.name | b64enc | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}